'use strict';

var oe = require('gzip-js');
var ie = require('tar-js');
var L = require('axios');
var zod = require('zod');
var Z = require('pino');

function _interopDefault (e) { return e && e.__esModule ? e : { default: e }; }

var oe__default = /*#__PURE__*/_interopDefault(oe);
var ie__default = /*#__PURE__*/_interopDefault(ie);
var L__default = /*#__PURE__*/_interopDefault(L);
var Z__default = /*#__PURE__*/_interopDefault(Z);

var T=class extends Error{url;status;statusText;body;request;constructor(e,o,n){super(n),this.name="ApiError",this.url=o.url,this.status=o.status,this.statusText=o.statusText,this.body=o.body,this.request=e;}};var w=class extends Error{constructor(e){super(e),this.name="CancelError";}get isCancelled(){return !0}},x=class{#r;#o;#e;#t;#n;#s;#i;constructor(e){this.#r=!1,this.#o=!1,this.#e=!1,this.#t=[],this.#n=new Promise((o,n)=>{this.#s=o,this.#i=n;let t=l=>{this.#r||this.#o||this.#e||(this.#r=!0,this.#s?.(l));},i=l=>{this.#r||this.#o||this.#e||(this.#o=!0,this.#i?.(l));},a=l=>{this.#r||this.#o||this.#e||this.#t.push(l);};return Object.defineProperty(a,"isResolved",{get:()=>this.#r}),Object.defineProperty(a,"isRejected",{get:()=>this.#o}),Object.defineProperty(a,"isCancelled",{get:()=>this.#e}),e(t,i,a)});}get[Symbol.toStringTag](){return "Cancellable Promise"}then(e,o){return this.#n.then(e,o)}catch(e){return this.#n.catch(e)}finally(e){return this.#n.finally(e)}cancel(){if(!(this.#r||this.#o||this.#e)){if(this.#e=!0,this.#t.length)try{for(let e of this.#t)e();}catch(e){console.warn("Cancellation threw an error",e);return}this.#t.length=0,this.#i?.(new w("Request aborted"));}}get isCancelled(){return this.#e}};var s={BASE:"https://sindri.app",VERSION:"1.5.40",WITH_CREDENTIALS:!1,CREDENTIALS:"include",TOKEN:void 0,USERNAME:void 0,PASSWORD:void 0,HEADERS:void 0,ENCODE_PATH:void 0};var O=window.File,P=window.FormData;var q=r=>r!=null,D=r=>typeof r=="string",F=r=>D(r)&&r!=="",$=r=>typeof r=="object"&&typeof r.type=="string"&&typeof r.stream=="function"&&typeof r.arrayBuffer=="function"&&typeof r.constructor=="function"&&typeof r.constructor.name=="string"&&/^(Blob|File)$/.test(r.constructor.name)&&/^(Blob|File)$/.test(r[Symbol.toStringTag]),U=r=>r instanceof P,K=r=>r>=200&&r<300,j=r=>{try{return btoa(r)}catch{return Buffer.from(r).toString("base64")}},G=r=>{let e=[],o=(t,i)=>{e.push(`${encodeURIComponent(t)}=${encodeURIComponent(String(i))}`);},n=(t,i)=>{q(i)&&(Array.isArray(i)?i.forEach(a=>{n(t,a);}):typeof i=="object"?Object.entries(i).forEach(([a,l])=>{n(`${t}[${a}]`,l);}):o(t,i));};return Object.entries(r).forEach(([t,i])=>{n(t,i);}),e.length>0?`?${e.join("&")}`:""},z=(r,e)=>{let o=r.ENCODE_PATH||encodeURI,n=e.url.replace("{api-version}",r.VERSION).replace(/{(.*?)}/g,(i,a)=>e.path?.hasOwnProperty(a)?o(String(e.path[a])):i),t=`${r.BASE}${n}`;return e.query?`${t}${G(e.query)}`:t},W=r=>{if(r.formData){if(r.formData instanceof P)return r.formData;let e=new P,o=(n,t)=>{D(t)||$(t)?e.append(n,t):e.append(n,JSON.stringify(t));};return Object.entries(r.formData).filter(([n,t])=>q(t)).forEach(([n,t])=>{Array.isArray(t)?t.forEach(i=>o(n,i)):o(n,t);}),e}},v=async(r,e)=>typeof e=="function"?e(r):e,M=async(r,e,o)=>{let n=await v(e,r.TOKEN),t=await v(e,r.USERNAME),i=await v(e,r.PASSWORD),a=await v(e,r.HEADERS),l=o&&"getHeaders"in o&&typeof o?.getHeaders=="function"&&o?.getHeaders()||{},u=Object.entries({Accept:"application/json",...a,...e.headers,...l}).filter(([c,p])=>q(p)).reduce((c,[p,m])=>({...c,[p]:String(m)}),{});if(F(n)&&(u.Authorization=`Bearer ${n}`),F(t)&&F(i)){let c=j(`${t}:${i}`);u.Authorization=`Basic ${c}`;}return e.body&&(e.mediaType?u["Content-Type"]=e.mediaType:$(e.body)?u["Content-Type"]=e.body.type||"application/octet-stream":D(e.body)?u["Content-Type"]="text/plain":U(e.body)||(u["Content-Type"]="application/json")),u},J=r=>{if(r.body)return r.body},V=async(r,e,o,n,t,i,a,l)=>{let u=L__default.default.CancelToken.source(),c={url:o,headers:i,data:n??t,method:e.method,withCredentials:r.WITH_CREDENTIALS,cancelToken:u.token};a(()=>u.cancel("The user aborted a request."));try{return await l.request(c)}catch(p){let m=p;if(m.response)return m.response;throw p}},Q=(r,e)=>{if(e){let o=r.headers[e];if(D(o))return o}},X=r=>{if(r.status!==204)return r.data},Y=(r,e)=>{let n={400:"Bad Request",401:"Unauthorized",403:"Forbidden",404:"Not Found",500:"Internal Server Error",502:"Bad Gateway",503:"Service Unavailable",...r.errors}[e.status];if(n)throw new T(r,e,n);if(!e.ok){let t=e.status??"unknown",i=e.statusText??"unknown",a=(()=>{try{return JSON.stringify(e.body,null,2)}catch{return}})();throw new T(r,e,`Generic Error: status: ${t}; status text: ${i}; body: ${a}`)}},d=(r,e,o=L__default.default)=>new x(async(n,t,i)=>{try{let a=z(r,e),l=W(e),u=J(e),c=await M(r,e,l);if(!i.isCancelled){let p=await V(r,e,a,u,l,c,i,o),m=X(p),b=Q(p,e.responseHeader),g={url:a,ok:K(p.status),status:p.status,statusText:p.statusText,body:b??m};Y(e,g),n(g.body);}}catch(a){t(a);}});var h=class{static circuitCreate(e){return d(s,{method:"POST",url:"/api/v1/circuit/create",formData:e,mediaType:"multipart/form-data",errors:{412:"Precondition Failed",422:"Unprocessable Entity",500:"Internal Server Error",501:"Not Implemented"}})}static circuitList(e=!1){return d(s,{method:"GET",url:"/api/v1/circuit/list",query:{include_verification_key:e},errors:{500:"Internal Server Error"}})}static circuitDetail(e,o=!0){return d(s,{method:"GET",url:"/api/v1/circuit/{circuit_id}/detail",path:{circuit_id:e},query:{include_verification_key:o},errors:{404:"Not Found",500:"Internal Server Error"}})}static circuitDelete(e){return d(s,{method:"DELETE",url:"/api/v1/circuit/{circuit_id}/delete",path:{circuit_id:e},errors:{404:"Not Found",500:"Internal Server Error"}})}static circuitProofs(e,o=!1,n=!1,t=!1,i=!1){return d(s,{method:"GET",url:"/api/v1/circuit/{circuit_id}/proofs",path:{circuit_id:e},query:{include_proof_input:o,include_proof:n,include_public:t,include_verification_key:i},errors:{404:"Not Found",500:"Internal Server Error"}})}static proofCreate(e,o){return d(s,{method:"POST",url:"/api/v1/circuit/{circuit_id}/prove",path:{circuit_id:e},formData:o,mediaType:"application/x-www-form-urlencoded",errors:{404:"Not Found",412:"Precondition Failed",501:"Not Implemented"}})}};var C=class{static proofList(e=!1,o=!1,n=!1,t=!1){return d(s,{method:"GET",url:"/api/v1/proof/list",query:{include_proof_input:e,include_proof:o,include_public:n,include_verification_key:t},errors:{500:"Internal Server Error"}})}static proofDetail(e,o=!0,n=!0,t=!0,i=!0){return d(s,{method:"GET",url:"/api/v1/proof/{proof_id}/detail",path:{proof_id:e},query:{include_proof_input:o,include_proof:n,include_public:t,include_verification_key:i},errors:{404:"Not Found",500:"Internal Server Error"}})}static proofDelete(e){return d(s,{method:"DELETE",url:"/api/v1/proof/{proof_id}/delete",path:{proof_id:e},errors:{404:"Not Found",500:"Internal Server Error"}})}};var A=Z__default.default({browser:{asObject:!0}});A.level="silent";var ee=zod.z.object({auth:zod.z.nullable(zod.z.object({apiKey:zod.z.string(),apiKeyId:zod.z.string(),apiKeyName:zod.z.string(),baseUrl:zod.z.string().url(),teamId:zod.z.number(),teamSlug:zod.z.string()})).default(null)});ee.parse({});var _=class{pollingInterval=1e3;constructor(e={}){this.authorize(e);}get apiKey(){return s.TOKEN&&typeof s.TOKEN!="string"?null:s.TOKEN||null}get baseUrl(){return s.BASE}get logLevel(){return A.level}set logLevel(e){A.level=e;}authorize(e){return s.BASE=e.baseUrl||"https://sindri.app",s.TOKEN=e.apiKey,!!(s.BASE&&s.TOKEN)}async createCircuit(e,o=["latest"]){let n=new P;o=typeof o=="string"?[o]:o??[];for(let c of o){if(!/^[-a-zA-Z0-9_]+$/.test(c))throw new Error(`"${c}" is not a valid tag. Tags may only contain alphanumeric characters, underscores, and hyphens.`);n.append("tags",c);}if(o.length===0&&n.append("tags",""),typeof e=="string"){throw new Error("Specifying `project` as a path is not allowed in the browser build.");}else if(Array.isArray(e)){if(!e.every(y=>y instanceof O))throw new Error("All entries in `project` must be `File` instances.");let c=e.find(y=>y.name==="sindri.json");if(!c)throw new Error("The `project` array must include a `sindri.json` file.");let p;try{p=JSON.parse(await c.text());}catch{throw new Error('Could not parse "sindri.json", is it valid JSON?')}let m=p?.name;if(!m)throw new Error('No circuit "name" field was found in "sindri.json", the manifest is invalid.');let b=new ie__default.default;e.sort((y,S)=>y.name.localeCompare(S.name));for(let y of e){let S=new Uint8Array(await y.arrayBuffer());await new Promise(N=>b.append(`${m}/${y.name}`,S,N));}let g=new Uint8Array(oe__default.default.zip(b.out)),I=new O([g],`${m}.tar.gz`);n.append("files",I);}let t=s.HEADERS;s.HEADERS={"Content-Type":"multipart/form-data; boundary=----WebKitFormBoundary0buQ8d6EhWcs9X9d"};let a=await h.circuitCreate(n);s.HEADERS=t;let l=a.circuit_id,u;for(;u=await h.circuitDetail(l,!1),!(u.status==="Ready"||u.status==="Failed");)await new Promise(c=>setTimeout(c,this.pollingInterval));return u}async getAllCircuitProofs(e){return await h.circuitProofs(e)}async getAllCircuits(){return await h.circuitList()}async getAllProofs(){return await C.proofList()}async getCircuit(e){return await h.circuitDetail(e)}async getProof(e){return await C.proofDetail(e)}async proveCircuit(e,o){let n=await h.proofCreate(e,{proof_input:o}),t;for(;t=await C.proofDetail(n.proof_id),!(t.status==="Ready"||t.status==="Failed");)await new Promise(i=>setTimeout(i,this.pollingInterval));return t}};var kr=new _;

module.exports = kr;
//# sourceMappingURL=out.js.map
//# sourceMappingURL=index.js.map